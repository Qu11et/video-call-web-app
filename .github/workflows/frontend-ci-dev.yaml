name: Frontend Deploy VM (GitOps Lite)

concurrency:
  group: deploy-vm-dev-frontend
  cancel-in-progress: true

on:
  push:
    branches: [ "dev" ]
    paths:
      - 'video-call-frontend/**'
      - 'operation/**'
      - '.github/workflows/frontend-ci-dev.yaml'

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-frontend
  DEPLOY_PATH: /home/${{ secrets.GCP_VM_USER }}/video-call-web-app/operation/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. BUILD & PUSH FRONTEND ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Frontend Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker build -t $FULL_IMAGE ./video-call-frontend
          docker push $FULL_IMAGE

      # --- 2. DEPLOY ---
      - name: Trigger Server Update
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          REPO_NAME: ${{ env.REPO_NAME }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          port: 22
          envs: IMAGE_TAG,PROJECT_ID,REGION,REPO_NAME,IMAGE_NAME,DEPLOY_PATH
          script: |
            # ✅ SỬA 1: Lùi 1 cấp về Git Root
            cd $DEPLOY_PATH/..
            
            git fetch origin dev
            git reset --hard origin/dev
            
            cd $DEPLOY_PATH
            touch .env

            update_env() {
              key=$1
              val=$2
              sed -i "/^$key=/d" .env
              echo "$key=$val" >> .env
            }

            update_env "GCP_PROJECT_ID" "$PROJECT_ID"
            update_env "GCP_REGION" "$REGION"
            update_env "GCP_REPO_NAME" "$REPO_NAME"
            
            # ✅ Cập nhật FRONTEND
            update_env "FRONTEND_TAG" "$IMAGE_TAG"
            
            # ✅ SỬA 2: Kiểm tra BACKEND_TAG để tránh lỗi
            if ! grep -q "BACKEND_TAG=" .env; then
               echo "BACKEND_TAG=latest" >> .env
            fi

            # echo "--- Content of .env ---"
            # cat .env

            # Deploy Frontend
            docker compose pull frontend
            docker compose up -d --remove-orphans frontend
            docker image prune -f