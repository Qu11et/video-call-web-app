name: Backend CI/CD Pipeline (Sonar + Trivy + Build + GitOps)

on:
  # CH·ªà TRIGGER KHI C√ì PULL REQUEST
  pull_request:
    branches: [ "main" ]
    paths:
      - 'video-call-web-app/**'
      - '.github/workflows/backend-ci.yaml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-backend
  GITOPS_REPO: Qu11et/video-call-web-argocd
  DOCKER_BUILD_CONTEXT: ./video-call-web-app

jobs:
  check-quality-and-security:
    name: Code Quality & Security Check
    runs-on: ubuntu-latest
    
    # ‚úÖ KH·ªûI T·∫†O C√ÅC D·ªäCH V·ª§ GI·∫¢ L·∫¨P (Service Containers)
    services:
      # 1. Postgres Database
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: video_call_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # 2. Redis Cache (Th√™m c√°i n√†y ƒë·ªÉ fix l·ªói Redis)
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # 3. MongoDB (Th√™m c√°i n√†y ƒë·ªÉ fix l·ªói Mongo)
      mongo:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: password123
          MONGO_INITDB_DATABASE: meeting_history_db
        ports:
          - 27017:27017
        # Health check ƒë∆°n gi·∫£n cho Mongo
        options: >-
          --health-cmd "echo 'db.runCommand({ping:1})' | mongosh localhost:27017/test --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build and Analyze with SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        working-directory: ${{ env.DOCKER_BUILD_CONTEXT }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dspring.datasource.url=jdbc:postgresql://localhost:5432/video_call_db \
          -Dspring.datasource.username=postgres \
          -Dspring.datasource.password=password123 \
          -Dspring.data.redis.host=localhost \
          -Dspring.data.redis.port=6379 \
          -Dspring.data.mongodb.uri="mongodb://root:password123@localhost:27017/meeting_history_db?authSource=admin" \
          -Dlivekit.url=ws://localhost:7880 \
          -Dlivekit.api.key=devkey \
          -Dlivekit.api.secret=secret

  build-and-scan:
    name: Build & Security Scan
    needs: check-quality-and-security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV
          echo "üî® Building image: $FULL_IMAGE_NAME"
          docker build -t $FULL_IMAGE_NAME ${{ env.DOCKER_BUILD_CONTEXT }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.FULL_IMAGE_NAME }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL'

      # ‚ÑπÔ∏è Image ƒë∆∞·ª£c build nh∆∞ng KH√îNG push trong CI