name: Frontend CI/CD Pipeline (Sonar + Trivy + Build)

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'video-call-frontend/**'
      - '.github/workflows/frontend-ci.yaml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-frontend
  GITOPS_REPO: Qu11et/video-call-web-argocd
  # ƒê∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c ch·ª©a code frontend
  DOCKER_BUILD_CONTEXT: ./video-call-frontend

jobs:
  check-quality-and-security:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # B·∫Øt bu·ªôc cho SonarCloud

      # --- 1. SONARQUBE / SONARCLOUD SCAN (JS/TS Version) ---
      # Kh√°c v·ªõi Java, Frontend d√πng Action tr·ª±c ti·∫øp
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_FE }}
        with:
          # Ch·ªâ ƒë·ªãnh th∆∞ m·ª•c ch·ª©a source code frontend
          projectBaseDir: video-call-frontend
          args: >
            -Dsonar.organization=qu11et
            -Dsonar.projectKey=qu11et_video-call-web-UI
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.tsx,**/*.spec.ts
            -Dsonar.exclusions=**/node_modules/**,**/*.css,**/*.svg

  build-and-scan:
    name: Build & Security Scan
    needs: check-quality-and-security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV
          echo "üî® Building image: $FULL_IMAGE_NAME"
          docker build -t $FULL_IMAGE_NAME ${{ env.DOCKER_BUILD_CONTEXT }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.FULL_IMAGE_NAME }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # ‚ÑπÔ∏è Image ƒë∆∞·ª£c build nh∆∞ng KH√îNG push trong CI

      