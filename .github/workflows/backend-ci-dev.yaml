name: Backend Deploy VM (GitOps Lite)

# ✅ QUAN TRỌNG: Ngăn chặn deploy chồng chéo
concurrency:
  group: deploy-vm-dev
  cancel-in-progress: true

on:
  push:
    branches: [ "dev" ]
    paths:
      - 'video-call-web-app/**'
      - 'operation/**' # Chạy khi sửa file deploy
      - '.github/workflows/backend-deploy-vm-gitops.yaml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-backend
  # Đường dẫn tới thư mục chứa docker-compose trên VM (đã clone ở Bước 3)
  DEPLOY_PATH: /home/${{ secrets.GCP_VM_USER }}/video-call-web-app/operation/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. BUILD & PUSH IMAGE (Giữ nguyên) ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Backend Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker build -t $FULL_IMAGE ./video-call-web-app
          docker push $FULL_IMAGE

      # --- 2. DEPLOY (GITOPS LITE - FULL VARIABLES) ---
      - name: Trigger Server Pull & Update
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Truyền các biến từ Workflow vào Action
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          REPO_NAME: ${{ env.REPO_NAME }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          port: 22
          # ✅ Khai báo danh sách các biến cần dùng trong script bên dưới
          envs: IMAGE_TAG,PROJECT_ID,REGION,REPO_NAME,IMAGE_NAME,DEPLOY_PATH
          script: |
            # 1. Pull code mới nhất từ Git (như cũ)
            cd $DEPLOY_PATH/../../
            git fetch origin dev
            git reset --hard origin/dev

            # 2. Vào thư mục deploy
            cd $DEPLOY_PATH

            # 3. TẠO FILE .env ĐỘNG (QUAN TRỌNG)
            # Lệnh này sẽ tạo mới (hoặc ghi đè) file .env với đầy đủ thông tin
            echo "# Auto-generated by GitHub Actions at $(date)" > .env
            echo "GCP_PROJECT_ID=$PROJECT_ID" >> .env
            echo "GCP_REGION=$REGION" >> .env
            echo "GCP_REPO_NAME=$REPO_NAME" >> .env
            echo "GCP_IMAGE_NAME=$IMAGE_NAME" >> .env
            echo "IMAGE_TAG=$IMAGE_TAG" >> .env

            # 4. Kiểm tra xem file .env đã có nội dung chưa (để debug)
            cat .env

            # 5. Deploy
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f