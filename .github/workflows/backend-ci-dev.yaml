name: Backend Deploy VM (GitOps Lite)

concurrency:
  group: deploy-vm-dev
  cancel-in-progress: true

on:
  push:
    branches: [ "dev" ]
    paths:
      - 'video-call-web-app/**'
      - 'operation/**'
      - '.github/workflows/backend-ci-dev.yaml'

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }} # D√πng Vars cho linh ho·∫°t
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-backend
  # ƒê∆∞·ªùng d·∫´n n√†y ƒê√öNG r·ªìi, gi·ªØ nguy√™n
  DEPLOY_PATH: /home/${{ secrets.GCP_VM_USER }}/video-call-web-app/operation/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. BUILD & PUSH IMAGE ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Backend Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker build -t $FULL_IMAGE ./video-call-web-app
          docker push $FULL_IMAGE

      # --- 2. DEPLOY ---
      - name: Trigger Server Pull & Update
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          REPO_NAME: ${{ env.REPO_NAME }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          # ... (C√°c secret kh√°c gi·ªØ nguy√™n nh∆∞ b·∫°n ƒë√£ l√†m) ...
          DB_PASSWORD: ${{ secrets.APP_DB_PASSWORD }}
          MONGO_PASSWORD: ${{ secrets.APP_MONGO_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.APP_JWT_SECRET }}
          MAIL_USERNAME: ${{ secrets.APP_MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.APP_MAIL_PASSWORD }}
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          port: 22
          envs: IMAGE_TAG,PROJECT_ID,REGION,REPO_NAME,IMAGE_NAME,DEPLOY_PATH,DB_PASSWORD,MONGO_PASSWORD,JWT_SECRET_KEY,MAIL_USERNAME,MAIL_PASSWORD,LIVEKIT_URL,LIVEKIT_API_KEY,LIVEKIT_API_SECRET,COOKIE_DOMAIN
          script: |
            # ‚úÖ S·ª¨A 1: Ch·ªâ l√πi 1 c·∫•p ƒë·ªÉ v·ªÅ Git Root (/home/user/video-call-web-app/)
            cd $DEPLOY_PATH/..
            
            echo "Pulling latest code..."
            git fetch origin dev
            git reset --hard origin/dev
            
            # V√†o l·∫°i th∆∞ m·ª•c ch·ª©a docker-compose
            cd $DEPLOY_PATH

            touch .env

            update_env() {
              key=$1
              val=$2
              sed -i "/^$key=/d" .env
              echo "$key=$val" >> .env
            }

            # C·∫≠p nh·∫≠t Config
            update_env "GCP_PROJECT_ID" "$PROJECT_ID"
            update_env "GCP_REGION" "$REGION"
            update_env "GCP_REPO_NAME" "$REPO_NAME"
            
            # ‚úÖ C·∫≠p nh·∫≠t BACKEND
            update_env "BACKEND_TAG" "$IMAGE_TAG"

            # ‚úÖ S·ª¨A 2: Ki·ªÉm tra FRONTEND_TAG ƒë·ªÉ tr√°nh l·ªói
            if ! grep -q "FRONTEND_TAG=" .env; then
               echo "FRONTEND_TAG=latest" >> .env
            fi

            # C·∫≠p nh·∫≠t Secrets (Gi·ªØ nguy√™n ph·∫ßn c·ªßa b·∫°n)
            update_env "DB_PASSWORD" "$DB_PASSWORD"
            update_env "MONGO_PASSWORD" "$MONGO_PASSWORD"
            update_env "JWT_SECRET_KEY" "$JWT_SECRET_KEY"
            update_env "MAIL_USERNAME" "$MAIL_USERNAME"
            update_env "MAIL_PASSWORD" "$MAIL_PASSWORD"
            update_env "LIVEKIT_URL" "$LIVEKIT_URL"
            update_env "LIVEKIT_API_KEY" "$LIVEKIT_API_KEY"
            update_env "LIVEKIT_API_SECRET" "$LIVEKIT_API_SECRET"
            update_env "COOKIE_DOMAIN" "$COOKIE_DOMAIN"

            # B·ªè sleep, ch·ªâ c·∫ßn up t·∫•t c·∫£ c√πng l√∫c
            echo "üöÄ Starting all services..."
            cd $DEPLOY_PATH
            
            # Up databases tr∆∞·ªõc (n·∫øu ch∆∞a ch·∫°y)
            docker compose -f docker-compose.postgres.yml up -d
            
            # Pull backend image m·ªõi
            docker compose pull backend
            
            # Up backend NH∆ØNG KH√îNG d√πng --remove-orphans (ƒë·ªÉ gi·ªØ databases)
            docker compose up -d backend
            
            docker image prune -f
            echo "‚úÖ Deployment completed!"