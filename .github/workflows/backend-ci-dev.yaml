name: Backend Deploy VM (GitOps Lite)

# âœ… QUAN TRá»ŒNG: NgÄƒn cháº·n deploy chá»“ng chÃ©o
concurrency:
  group: deploy-vm-dev
  cancel-in-progress: true

on:
  push:
    branches: [ "dev" ]
    paths:
      - 'video-call-web-app/**'
      - 'operation/**' # Cháº¡y khi sá»­a file deploy
      - '.github/workflows/backend-ci-dev.yaml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-backend
  # ÄÆ°á»ng dáº«n tá»›i thÆ° má»¥c chá»©a docker-compose trÃªn VM (Ä‘Ã£ clone á»Ÿ BÆ°á»›c 3)
  DEPLOY_PATH: /home/${{ secrets.GCP_VM_USER }}/video-call-web-app/operation/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. BUILD & PUSH IMAGE (Giá»¯ nguyÃªn) ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Backend Image
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
        run: |
          FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker build -t $FULL_IMAGE ./video-call-web-app
          docker push $FULL_IMAGE

      # --- 2. DEPLOY (GITOPS LITE - FULL VARIABLES) ---
      - name: Trigger Server Pull & Update
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Truyá»n cÃ¡c biáº¿n tá»« Workflow vÃ o Action
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          REPO_NAME: ${{ env.REPO_NAME }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}

          # ðŸ‘‡ CÃC BIáº¾N Máº¬T (Láº¥y tá»« Secrets)
          DB_PASSWORD: ${{ secrets.APP_DB_PASSWORD }}
          MONGO_PASSWORD: ${{ secrets.APP_MONGO_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.APP_JWT_SECRET }}
          MAIL_USERNAME: ${{ secrets.APP_MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.APP_MAIL_PASSWORD }}
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          port: 22
          # ðŸ‘‡ Äá»«ng quÃªn liá»‡t kÃª tÃªn biáº¿n vÃ o Ä‘Ã¢y
          envs: IMAGE_TAG,PROJECT_ID,REGION,REPO_NAME,IMAGE_NAME,DEPLOY_PATH,DB_PASSWORD,MONGO_PASSWORD,JWT_SECRET_KEY,MAIL_USERNAME,MAIL_PASSWORD,LIVEKIT_URL,LIVEKIT_API_KEY,LIVEKIT_API_SECRET,COOKIE_DOMAIN
          script: |
            cd $DEPLOY_PATH/../../
            git fetch origin dev
            git reset --hard origin/dev
            
            cd $DEPLOY_PATH

            # Äáº£m báº£o file .env tá»“n táº¡i
            touch .env

            # HÃ m cáº­p nháº­t biáº¿n an toÃ n
            update_env() {
              key=$1
              val=$2
              # XÃ³a dÃ²ng cÅ© vÃ  thÃªm dÃ²ng má»›i
              sed -i "/^$key=/d" .env
              echo "$key=$val" >> .env
            }

            # --- Cáº¬P NHáº¬T BIáº¾N Cáº¤U HÃŒNH Háº  Táº¦NG ---
            update_env "GCP_PROJECT_ID" "$PROJECT_ID"
            update_env "GCP_REGION" "$REGION"
            update_env "GCP_REPO_NAME" "$REPO_NAME"
            update_env "BACKEND_TAG" "$IMAGE_TAG"

            # --- Cáº¬P NHáº¬T BIáº¾N MÃ”I TRÆ¯á»œNG APP (APP SECRETS) ---
            update_env "DB_PASSWORD" "$DB_PASSWORD"
            update_env "MONGO_PASSWORD" "$MONGO_PASSWORD"
            update_env "JWT_SECRET_KEY" "$JWT_SECRET_KEY"
            update_env "MAIL_USERNAME" "$MAIL_USERNAME"
            update_env "MAIL_PASSWORD" "$MAIL_PASSWORD"
            update_env "LIVEKIT_URL" "$LIVEKIT_URL"
            update_env "LIVEKIT_API_KEY" "$LIVEKIT_API_KEY"
            update_env "LIVEKIT_API_SECRET" "$LIVEKIT_API_SECRET"
            update_env "COOKIE_DOMAIN" "$COOKIE_DOMAIN"

            # Deploy
            docker compose pull backend
            docker compose up -d --remove-orphans backend
            docker image prune -f