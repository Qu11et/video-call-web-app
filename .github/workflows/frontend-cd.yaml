name: Frontend Deploy to Production

on:
  push:
    branches: [ "main" ]
    paths:
      - 'video-call-frontend/**'
      - '.github/workflows/frontend-ci.yaml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-southeast1
  REPO_NAME: video-call-repo
  IMAGE_NAME: video-call-frontend
  GITOPS_REPO: Qu11et/video-call-web-argocd
  DOCKER_BUILD_CONTEXT: ./video-call-frontend

jobs:
  pull-and-deploy:
    name: Pull & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Image Tag
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Pull scanned image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker pull $IMAGE    

      - name: Promote image to prod
        run: |
          PROD_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:prod-${IMAGE_TAG}"
          echo "PROD_IMAGE=$PROD_IMAGE" >> $GITHUB_ENV
          docker tag $IMAGE $PROD_IMAGE        

      - name: Push prod image
        run: docker push ${{ env.PROD_IMAGE }}

      - name: Update GitOps Repo
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
          IMAGE_TAG: ${IMAGE_TAG}
        run: |
          FULL_IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          
          echo "üöÄ Deploying image: ${FULL_IMAGE_NAME}"
          
          git config --global user.email "ci-bot@example.com"
          git config --global user.name "CI Bot"
          
          git clone https://x-access-token:${GITOPS_TOKEN}@github.com/${{ env.GITOPS_REPO }}.git
          cd video-call-web-argocd
          
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
          
          yq -i "select(.kind == \"Deployment\" and .metadata.name == \"frontend\").spec.template.spec.containers[0].image = \"${PROD_IMAGE}\"" web-app/2-app.yaml
          
          git add .
          if ! git diff-index --quiet HEAD; then
            git commit -m "deploy(frontend): update image to ${IMAGE_TAG}"
            
            for i in {1..3}; do
              git pull --rebase origin main && git push origin main && break
              echo "‚ö†Ô∏è  Push failed, retrying ($i/3)..."
              sleep 2
            done
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi