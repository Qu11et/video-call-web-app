version: '3.8'

services:
  # --- 1. Nginx Proxy Manager (C·ªïng ch√≠nh - Gateway) ---
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'     # C·ªïng Web HTTP
      - '81:81'     # C·ªïng Admin qu·∫£n l√Ω
      - '443:443'   # C·ªïng Web HTTPS (SSL)
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    depends_on:
      - frontend-container
      - livekit
    networks:
      - app-network  

  # --- 2. Backend Service ---
  version: '3.8'
  services:
    backend:
      image: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_REPO_NAME}/video-call-backend:${BACKEND_TAG}
      ports:
        - "8080:8080"
      restart: always
      # üëá KHAI B√ÅO C√ÅC BI·∫æN M√îI TR∆Ø·ªúNG ·ªû ƒê√ÇY
      environment:
        - SPRING_PROFILES_ACTIVE=dev
        # Database
        - DB_HOST=postgres
        - DB_NAME=video_call_db
        - DB_USERNAME=postgres
        - DB_PASSWORD=${DB_PASSWORD} # L·∫•y t·ª´ file .env
        # Mongo
        - MONGO_HOST=mongo
        - MONGO_USER=root
        - MONGO_PASSWORD=${MONGO_PASSWORD} # L·∫•y t·ª´ file .env
        # Redis
        - REDIS_HOST=redis
        # Security & Config
        - JWT_SECRET_KEY=${JWT_SECRET_KEY}
        - COOKIE_DOMAIN=${COOKIE_DOMAIN}
        - COOKIE_SECURE=true
        # Email
        - MAIL_USERNAME=${MAIL_USERNAME}
        - MAIL_PASSWORD=${MAIL_PASSWORD}
        # LiveKit
        - LIVEKIT_URL=${LIVEKIT_URL}
        - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
        - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
    depends_on:
      - redis
    networks:
      - app-network  

  # --- 3. Frontend Service ---
  frontend-container:
    image: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_REPO_NAME}/video-call-frontend:${FRONTEND_TAG}
    restart: always
    # KH√îNG expose port 80 ra ngo√†i n·ªØa, ch·ªâ ch·∫°y trong m·∫°ng Docker
    expose:
      - "80" 
    depends_on:
      - backend-container
    networks:
      - app-network  

  # --- 4. LiveKit Server ---
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    restart: unless-stopped
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
      # QUAN TR·ªåNG: M·ªü d·∫£i port UDP cho Video Stream
      - "50000-50100:50000-50100/udp"
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    depends_on:
      - redis
    networks:
      - app-network  

  # --- 5. Redis ---
  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - app-network

# ƒê·ªãnh nghƒ©a network chung ƒë·ªÉ c√°c container nh√¨n th·∫•y nhau
networks:
  app-network:
    driver: bridge
    external: true

      