version: '3.8'

services:
  # --- 1. Nginx Proxy Manager (Cổng chính - Gateway) ---
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'     # Cổng Web HTTP
      - '81:81'     # Cổng Admin quản lý
      - '443:443'   # Cổng Web HTTPS (SSL)
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    depends_on:
      - frontend-container
      - livekit
    networks:
      - app-network  

  # --- 2. Backend Service ---
  backend-container:
    # Sử dụng biến môi trường, không hardcode phiên bản
    image: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GCP_REPO_NAME}/${GCP_IMAGE_NAME}:${IMAGE_TAG}
    restart: always
    environment:
      - SERVER_PORT=8080
      # Quan trọng: URL LiveKit giờ là wss://livekit.tenmien.com
      - LIVEKIT_URL=ws://localhost:7880 
    depends_on:
      - redis
    networks:
      - app-network  

  # --- 3. Frontend Service ---
  frontend-container:
    build: ../video-call-frontend
    restart: always
    # KHÔNG expose port 80 ra ngoài nữa, chỉ chạy trong mạng Docker
    expose:
      - "80" 
    depends_on:
      - backend-container
    networks:
      - app-network  

  # --- 4. LiveKit Server ---
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    restart: unless-stopped
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
      # QUAN TRỌNG: Mở dải port UDP cho Video Stream
      - "50000-50100:50000-50100/udp"
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    depends_on:
      - redis
    networks:
      - app-network  

  # --- 5. Redis ---
  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - app-network

# Định nghĩa network chung để các container nhìn thấy nhau
networks:
  app-network:
    driver: bridge
    external: true

      